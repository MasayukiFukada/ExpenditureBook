<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- <link th:href="@{/css/design_debug.css}" rel="stylesheet" /> -->
    <link th:href="@{/css/main.css}" rel="stylesheet" />
    <script src="https://unpkg.com/vue@2.7.16"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>出費管理</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
    <div id="app">
        <div><a href="/edit">項目編集画面へ</a></div>
        <div><a href="/category_master">カテゴリマスタメンテ画面へ</a></div>
        <div>
            <div>
                <select id="select_year">
                    <th:block th:each="data:${year}">
                        <option th:value="${data}" th:text="${data}" th:selected="${data == currentYear}"></option>
                    </th:block>
                </select>
            </div>
            <div>
                <div><button type="button" @click="filter()">表示</button></div>
                <div><input type="file" id="input_file"></div>
                <div><button type="button" @click="loadCSV()">CSV読み込み</button></div>
            </div>
            <div>
                <Table id="tbl_result">
                    <thead>
                        <tr>
                            <td class="tbl_head">月</td>
                            <td class="tbl_head">小計</td>
                            <td class="tbl_head">住居</td>
                            <td class="tbl_head">水道光熱</td>
                            <td class="tbl_head">通信</td>
                            <td class="tbl_head">保険</td>
                            <td class="tbl_head">食費</td>
                            <td class="tbl_head">日用</td>
                            <td class="tbl_head">被服</td>
                            <td class="tbl_head">交際</td>
                            <td class="tbl_head">交通</td>
                            <td class="tbl_head">趣味</td>
                            <td class="tbl_head">教育</td>
                            <td class="tbl_head">医療</td>
                            <td class="tbl_head">特別</td>
                            <td class="tbl_head">雑費</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr @click="select(item)" v-for="(item,key) in aggregates.items">
                            <td class="td_data_month"> {{item.month}} </td>
                            <td class="td_data_sum"> {{item.subTotalAmmount}} </td>
                            <td class="td_data_ammount" v-for="(c_item,c_key) in item.items" >
                                {{c_item.categoryAmmount}}
                            </td>
                        </tr>
                    </tbody>
                </Table>
            </div>
        </div>
    </div>
    <script type="text/javascript">

     var app = new Vue({
       el: '#app',
       data: {
         aggregates: [] // 仮 PlaceHolder
       },
       methods: {
         filter: async function() {
             var url = "/aggregate_filter"
             await axios.post(url,{
                 year: document.getElementById("select_year").value
             }).then(x => {
                 this.aggregates = x.data
             })
         },
         send_csv: async function(values) {
            var url = "/register_csv"
            await axios.post(url,{
                year: values[0],
                month: values[1],
                day: values[2],
                ammount: values[3],
                category_id: values[4],
                note: values[5]
            }).then(x => {
                console.log(x.data)
            })
         },
         loadCSV: function() {
            // CSV 読み込み。
            // MEMO: 権限とか要るかと思ったけど不要そう
            let reader = new FileReader()
            reader.onload = function (e) {
                // 読み込み完了時の処理
                // 改行コードは環境に依るかも
                let rows = e.target.result.split(/\r\n/)
                var firstLine = true
                rows.forEach((item) => {
                    if(firstLine) {
                        // 見出し行だけ飛ばす
                        firstLine = false
                    }else{
                        let values = item.split(/,/)
                        if(values.length > 1) {
                            app.send_csv(values)
                        }
                    }
                 })
            }
            let tag =document.getElementById("input_file")
            reader.readAsText(tag.files[0])
         }
       },
       beforeMount() {
         this.filter()
       }
     })
     </script>
</body>
</html>
