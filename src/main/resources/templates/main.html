<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <!-- ◆◆◆ d3.js はバージョンに注意 -->
        <script src="/chart/d3.js"  charset="utf-8"></script>
        <script src="/chart/billboard.js"></script>
        <link th:href="@{/chart/insight.css}" rel="stylesheet" />
        <script src="https://unpkg.com/vue@2.7.16"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <title>出費管理</title>
        <!-- ◆◆◆ Font awesome -->
        <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
        <!-- ◆◆◆ Bulma -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    </head>
    <body>
        <div id="app" class="container is-fluid">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    <a class="navbar-item" href="/">
                        <p class="title">出費管理</p>
                    </a>
                </div>
                <div class="navbar-menu">
                    <div class="navbar-start">
                        <a class="navbar-item" href="/edit">項目編集</a>
                        <a class="navbar-item" href="/category_master">カテゴリ設定</a>
                    </div>
                </div>
            </nav>

            <section class="section">
                <div class="box">
                    <div class="columns is-vcentered">
                        <div class="column is-narrow">
                            <div class="field has-addons">
                                <div class="control">
                                    <div class="select">
                                        <select id="select_year" @change="onPush_filter()">
                                            <th:block th:each="data:${year}">
                                                <option th:value="${data}" th:text="${data}" th:selected="${data == currentYear}"></option>
                                            </th:block>
                                        </select>
                                    </div>
                                </div>
                                <div class="control">
                                    <a class="button is-info">年 表示</a>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="level">
                                <div class="level-item has-text-centered">
                                    <div>
                                        <p class="heading">年間合計</p>
                                        <p class="title">{{totalAmmount}} 円</p>
                                    </div>
                                </div>
                                <div class="level-item has-text-centered">
                                    <div>
                                        <p class="heading">選択月</p>
                                        <p class="title">{{selectedMonth}} 月</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-narrow">
                            <div class="file is-info has-name">
                                <label class="file-label">
                                    <input id="input_file" class="file-input" type="file" name="resume" @change="onFileChange"/>
                                    <span class="file-cta">
                                        <span class="file-icon"><i class="fas fa-upload"></i></span>
                                        <span class="file-label">CSV選択</span>
                                    </span>
                                    <span class="file-name">{{ csvFileName }}</span>
                                </label>
                            </div>
                             <a class="button is-info is-fullwidth" @click="onPush_loadCSV()">CSV読み込み</a>
                        </div>
                    </div>
                </div>

                <div class="box">
                    <div class="columns">
                        <div class="column">
                            <p class="subtitle has-text-centered">各月総支出</p>
                            <div id="subTotalChart"></div>
                        </div>
                        <div class="column">
                            <p class="subtitle has-text-centered">カテゴリ別支出</p>
                            <div id="categoryChart"></div>
                        </div>
                        <div class="column">
                            <p id="donut-title" class="subtitle has-text-centered"></p>
                            <div id="chart"></div>
                        </div>
                    </div>
                </div>

                <div class="box">
                    <p class="subtitle">月のコメント</p>
                    <div class="field has-addons">
                        <div class="control has-icons-left is-expanded">
                            <input id="txt_comment_note" class="input" type="text" placeholder="コメント入力..."/>
                            <span class="icon is-small is-left"><i class="far fa-comment"></i></span>
                            <input id="txt_comment_id" class="input" type="hidden"/>
                        </div>
                        <div class="control">
                            <button class="button is-success" @click="update_comment()">コメント更新</button>
                        </div>
                    </div>
                </div>

                <div class="box">
                    <Table id="tbl_result" class="table is-bordered is-striped is-hoverable is-fullwidth">
                        <thead>
                            <tr>
                                <th>月</th>
                                <th class="is-primary">小計</th>
                                <th>住居</th>
                                <th>水道光熱</th>
                                <th>通信</th>
                                <th>保険</th>
                                <th class="is-warning">食費</th>
                                <th>日用</th>
                                <th>被服</th>
                                <th>交際</th>
                                <th>交通</th>
                                <th class="is-info">趣味</th>
                                <th>教育</th>
                                <th>医療</th>
                                <th>特別</th>
                                <th>雑費</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr @click="select(item)" v-for="(item,key) in aggregates.items" :class="{ 'is-selected': item.month == selectedMonth }">
                                <td class="td_data_month"> {{item.month}} </td>
                                <td class="td_data_sum has-background-primary-light"> {{item.subTotalAmmount}} </td>
                                <td class="td_data_ammount" v-for="(c_item,c_key) in item.items" >
                                    {{c_item.categoryAmmount}}
                                </td>
                            </tr>
                        </tbody>
                    </Table>
                </div>
            </section>
            <footer class="footer">
            </footer>
        </div>
        <script type="text/javascript">

         var app = new Vue({
           el: '#app',
           data: {
               aggregates: []
           ,   series:[]
           ,   columns: []
           ,   category: []
           ,   comments: []
           ,   chart: null
           ,   selectedMonth: 0
           ,   totalAmmount: 0
           ,   subTotalChart: null
           ,   categoryChart: null
           ,   csvFileName: 'ファイル未選択'
           },
           methods: {
             onFileChange: function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    this.csvFileName = e.target.files[0].name;
                } else {
                    this.csvFileName = 'ファイル未選択';
                }
             },
             onPush_filter: async function() {
                 var url = "/aggregate_filter"
                 await axios.post(url,{
                     year: document.getElementById("select_year").value
                 }).then(x => {
                     this.aggregates = x.data
                     this.totalAmmount = x.data.totalAmmount
                     this.refresh_comments()
                 })
             },
             refresh_comments: async function(){
                 var url = "/monthly_comments"
                 await axios.post(url,{
                     year: document.getElementById("select_year").value
                 }).then(x => {
                     this.comments = x.data
                 })
             },
             select: function(obj) {
                 // 選択月
                 this.selectedMonth = obj.month

                 // 各月のデータ
                 this.series = []
                 var array = []
                 array.push("各月総支出")
                 this.aggregates.items.forEach((item) =>{
                     array.push(item.subTotalAmmount)
                 })
                 this.series.push(array)

                 // 分類ごとのデータ
                 this.category = []
                 let isFirst = true
                 // 年間グラフ用に月をループ
                 this.aggregates.items.forEach((item) =>{
                    if(isFirst) {
                        isFirst = false
                        // 最初だけカテゴリ名を追加
                        item.items.forEach((cat) => {
                            this.category.push([cat.categoryName])
                        })
                    }
                    let index = 0
                    // カテゴリの種類毎にループ
                    if(item.month < 13) {
                        item.items.forEach((cat) =>{
                            this.category[index].push(cat.categoryAmmount)
                            index = index + 1
                        })
                    }
                 })

                 // 内訳のデータ
                 this.columns = []
                 obj.items.forEach((item) => {
                    var array = []
                    array.push(item.categoryName)
                    array.push(item.categoryAmmount)
                    this.columns.push(array)
                 })
                 this.subTotalChart.load({columns: this.series})
                 this.categoryChart.load({columns: this.category})
                 this.chart.load({columns: this.columns})
                 document.getElementById("donut-title").innerText = this.selectedMonth + '月 内訳'
                 this.load_comment(this.selectedMonth)
             },
             load_comment: function(month) {
                document.getElementById("txt_comment_id").value = ""
                document.getElementById("txt_comment_note").value = ""
                for(const item of this.comments) {
                    if( item.month == month ) {
                        document.getElementById("txt_comment_id").value = item.id
                        document.getElementById("txt_comment_note").value = item.comment
                    }
                }
             },
             update_comment: async function() {
                 if(this.selectedMonth == 0) {
                    return
                 }
                 var url = "/update_comment"
                 await axios.post(url,{
                     id: document.getElementById("txt_comment_id").value
                 ,   year: document.getElementById("select_year").value
                 ,   month: this.selectedMonth
                 ,   note: document.getElementById("txt_comment_note").value
                 }).then(x => {
                     this.comments = x.data
                 })
             },
             create_chart: function() {
                this.subTotalChart = bb.generate({
                    bindto: '#subTotalChart'
                ,   data: {
                        type : 'bar'
                    ,   x: "x"
                    ,   columns: [
                            ["x", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                        ,   [".", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] 
                        ]
                    }
                })
                this.subTotalChart.hide(".")
                this.subTotalChart.legend.hide(".")
                this.categoryChart = bb.generate({
                    bindto: '#categoryChart'
                ,   data: {
                        type : 'line'
                    ,   x: "x"
                    ,   columns: [
                            ["x", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                        ,   [".", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        ,   this.category
                        ]
                    }
                })
                this.categoryChart.hide(".")
                this.categoryChart.legend.hide(".")
                this.chart = bb.generate({
                    bindto: '#chart'
                ,   data: {
                        type : 'donut'
                    ,   columns: this.columns
                    }
                })
                document.getElementById("donut-title").innerText = '月を選択してください'
             },
             send_csv: async function(values) {
                var url = "/register_csv"
                await axios.post(url,{
                    year: values[0]
                ,   month: values[1]
                ,   day: values[2]
                ,   ammount: values[3]
                ,   category_id: values[4]
                ,   note: values[5]
                }).then(x => {
                    console.log(x.data)
                })
             },
             onPush_loadCSV: function() {
                let input = document.getElementById("input_file");
                if (input.files.length === 0) {
                    alert('CSVファイルを選択してください。');
                    return;
                }
                let reader = new FileReader()
                reader.onload = (e) => {
                    let rows = e.target.result.split(/\r\n|\n/)
                    var firstLine = true
                    rows.forEach((item) => {
                        if(firstLine) {
                            firstLine = false
                        }else{
                            let values = item.split(/,/)
                            if(values.length > 1) {
                                this.send_csv(values)
                            }
                        }
                     })
                    alert('CSVの読み込みが完了しました。画面を更新して確認してください。');
                }
                reader.readAsText(input.files[0])
             }
           },
           beforeMount() {
               this.onPush_filter()
           },
           mounted() {
               this.create_chart()
           }
         })
         </script>
    </body>
</html>
